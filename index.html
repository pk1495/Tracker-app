<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Tracker</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#d63384">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Daily Tracker">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-image: url('background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(255, 105, 180, 0.3);
        }

        .greeting {
            text-align: center;
            font-size: 2em;
            color: #d63384;
            margin-bottom: 30px;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(255, 192, 203, 0.5);
            position: relative;
        }

        .mail-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 2px solid #d63384;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0;
        }

        .mail-icon:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d6d;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .unread-badge:empty,
        .unread-badge[data-count="0"] {
            display: none;
        }

        /* Messaging Modal/Page */
        .messaging-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 2000;
            flex-direction: column;
        }

        .messaging-modal.active {
            display: flex;
        }

        .messaging-header {
            background: linear-gradient(135deg, #ff69b4 0%, #d63384 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .back-btn,
        .info-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .back-btn:hover,
        .info-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            font-size: 1.2em;
            font-weight: 600;
        }

        .online-status {
            font-size: 0.75em;
            opacity: 0.9;
        }

        .message-input-area {
            padding: 10px;
            background: white;
            border-top: 1px solid #f0f0f0;
        }

        .username-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .username-modal.active {
            display: flex;
        }

        .sender-name {
            font-size: 0.75em;
            font-weight: 600;
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .my-message .sender-name {
            text-align: right;
            color: #d63384;
        }

        .their-message .sender-name {
            text-align: left;
            color: #666;
        }

        /* Profile Picture Styles */
        .profile-picture-section {
            text-align: center;
            padding: 20px 0;
        }

        .profile-pic-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto;
            border: 3px solid #d63384;
            overflow: hidden;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .profile-pic-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-placeholder {
            font-size: 3em;
            color: #ccc;
        }

        .profile-pic-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid white;
        }

        .profile-pic-small img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-placeholder-small {
            font-size: 1.2em;
            color: white;
        }

        .message-profile-pic {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            overflow: hidden;
            margin-right: 8px;
            border: 1px solid #ddd;
            flex-shrink: 0;
        }

        .message-profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-with-pic {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        /* Image Cropping Modal */
        .crop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 4000;
            flex-direction: column;
        }

        .crop-modal.active {
            display: flex;
        }

        .crop-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .crop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.8);
        }

        .crop-title {
            color: white;
            font-size: 1.1em;
            font-weight: 600;
        }

        .crop-cancel-btn,
        .crop-done-btn {
            background: none;
            border: none;
            color: #ff69b4;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            padding: 8px 15px;
        }

        .crop-done-btn {
            color: #4a90e2;
        }

        .crop-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            touch-action: none;
        }

        #cropCanvas {
            max-width: 100%;
            max-height: 100%;
            cursor: move;
        }

        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .crop-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        }

        .crop-controls {
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
        }

        .zoom-control {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 400px;
            margin: 0 auto;
        }

        .zoom-control button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-control button:active {
            background: rgba(255, 255, 255, 0.3);
        }

        #zoomSlider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            outline: none;
        }

        #zoomSlider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
        }

        #zoomSlider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        @media (max-width: 600px) {
            .crop-circle {
                width: 240px;
                height: 240px;
            }
        }

        .section {
            margin-bottom: 35px;
            background: #fff5f9;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ffc0cb;
        }

        .section-title {
            font-size: 1.5em;
            color: #c2185b;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .task-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input[type="text"], textarea {
            flex: 1;
            padding: 12px;
            border: 2px solid #ffb3d9;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #d63384;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: inherit;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #ff69b4 0%, #d63384 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(214, 51, 132, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #ffd4e5;
            transition: background-color 0.3s;
        }

        .task-item:hover {
            background: #fff0f6;
        }

        .task-item.completed {
            opacity: 0.6;
        }

        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #999;
        }

        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #d63384;
        }

        .task-text {
            flex: 1;
            color: #333;
        }

        .delete-btn {
            padding: 6px 12px;
            background: #ff4d6d;
            font-size: 0.9em;
        }

        .water-tracker {
            text-align: center;
        }

        .water-reminder {
            font-size: 1.3em;
            color: #c2185b;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .water-glasses {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .water-glass {
            width: 50px;
            height: 60px;
            border: 3px solid #69b3ff;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            background: white;
            transition: all 0.3s;
        }

        .water-glass:hover {
            transform: scale(1.1);
        }

        .water-glass.filled {
            background: linear-gradient(to top, #69b3ff 0%, #a0d5ff 100%);
            border-color: #4a9fee;
        }

        .water-glass::after {
            content: '';
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            height: 3px;
            background: rgba(105, 179, 255, 0.3);
        }

        .water-count {
            margin-top: 15px;
            font-size: 1.1em;
            color: #4a9fee;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .loading {
            text-align: center;
            color: #d63384;
            padding: 20px;
        }

        /* Setup Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            margin: 20px;
        }

        .modal-title {
            font-size: 1.8em;
            color: #d63384;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #c2185b;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffb3d9;
            border-radius: 10px;
            font-size: 1em;
        }

        .setup-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            font-size: 0.85em;
            line-height: 1.6;
        }

        .setup-info a {
            color: #d63384;
            font-weight: 600;
        }

        .setup-info strong {
            display: block;
            margin-bottom: 5px;
            color: #c2185b;
        }

        .settings-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5em;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(214, 51, 132, 0.4);
        }

        /* Mail Button - Fixed Position */
        .mail-btn {
            position: fixed;
            bottom: 85px;
            right: 20px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff69b4 0%, #d63384 100%);
            color: white;
            border: none;
            font-size: 1.8em;
            box-shadow: 0 4px 12px rgba(214, 51, 132, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .mail-btn:hover {
            transform: scale(1.1);
        }

        .mail-btn .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4d6d;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            border: 2px solid white;
        }

        .mail-btn .unread-badge:empty,
        .mail-btn .unread-badge[data-count="0"] {
            display: none;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            font-size: 0.9em;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Love Notes Pinboard */
        .love-note-left {
            position: fixed;
            left: 20px;
            top: 150px;
            width: 200px;
            z-index: 100;
            background: #fffacd;
            padding: 15px;
            border-radius: 5px;
            min-height: 120px;
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.15);
            transform: rotate(-4deg);
            border: 1px solid #f0e68c;
        }

        .love-note-right {
            position: fixed;
            right: 20px;
            top: 150px;
            width: 200px;
            z-index: 100;
            background: #ffb3e6;
            padding: 15px;
            border-radius: 5px;
            min-height: 120px;
            box-shadow: 5px 5px 12px rgba(0, 0, 0, 0.15);
            transform: rotate(3deg);
            border: 1px solid #ff99d6;
        }

        .love-note-left::before,
        .love-note-right::before {
            content: 'üìå';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8em;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.2));
        }

        .note-input {
            width: 100%;
            border: none;
            background: transparent;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85em;
            resize: none;
            min-height: 70px;
            color: #333;
            padding: 5px;
        }

        .note-input:focus {
            outline: none;
        }

        .note-input::placeholder {
            color: #999;
            font-style: italic;
            font-size: 0.85em;
        }

        .note-display {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.85em;
            color: #333;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 70px;
        }

        .note-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            gap: 5px;
        }

        .note-btn {
            padding: 4px 8px;
            font-size: 0.7em;
            border-radius: 5px;
        }

        .edit-btn {
            background: #69b3ff;
        }

        .save-btn {
            background: #28a745;
        }

        /* Mobile responsive layout - Tablets and smaller laptops */
        @media (max-width: 1200px) {
            .container {
                display: flex;
                flex-direction: column;
                padding: 20px 15px;
            }

            /* Love notes at top */
            .love-note-left {
                position: relative;
                left: auto;
                top: auto;
                width: 100%;
                max-width: 350px;
                margin: 0 auto 15px auto;
                order: 1;
                transform: rotate(-2deg);
            }

            .love-note-right {
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                max-width: 350px;
                margin: 0 auto 20px auto;
                order: 2;
                transform: rotate(2deg);
            }

            /* Main content in middle */
            .greeting {
                order: 0;
                font-size: 1.5em;
            }

            .section {
                order: 3;
            }

            /* Music widgets at bottom */
            .music-widget-left {
                position: relative;
                left: auto;
                top: auto;
                width: 100%;
                max-width: 350px;
                margin: 15px auto;
                order: 10;
            }

            .music-widget-right {
                position: relative;
                right: auto;
                top: auto;
                width: 100%;
                max-width: 350px;
                margin: 15px auto;
                order: 11;
            }

            .settings-btn {
                bottom: 10px;
                right: 10px;
                width: 45px;
                height: 45px;
                font-size: 1.3em;
                order: 12;
            }
        }

        /* Large phones like S24 Ultra, iPhone Pro Max */
        @media (max-width: 900px) {
            body {
                padding: 15px;
            }

            .container {
                display: flex;
                flex-direction: column;
                padding: 20px 15px;
            }

            .greeting {
                order: 0;
                font-size: 1.4em;
            }

            .love-note-left,
            .love-note-right {
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                width: 90%;
                max-width: 350px;
                margin: 0 auto 15px auto;
            }

            .love-note-left {
                order: 1;
            }

            .love-note-right {
                order: 2;
            }

            .section {
                order: 3;
            }

            .music-widget-left,
            .music-widget-right {
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                width: 90%;
                max-width: 350px;
                margin: 15px auto;
            }

            .music-widget-left {
                order: 10;
            }

            .music-widget-right {
                order: 11;
            }
        }

        /* Small phone screens */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
                display: flex;
                flex-direction: column;
            }

            .greeting {
                font-size: 1.3em;
                margin-bottom: 20px;
                order: 0;
            }

            .section {
                padding: 15px;
                margin-bottom: 20px;
                order: 3;
            }

            .section-title {
                font-size: 1.2em;
            }

            .task-input-container {
                flex-direction: column;
            }

            input[type="text"], textarea {
                width: 100%;
            }

            button {
                width: 100%;
            }

            .task-item {
                flex-wrap: wrap;
                font-size: 0.95em;
            }

            .delete-btn {
                margin-top: 5px;
                width: 100%;
            }

            .water-glasses {
                gap: 8px;
            }

            .water-glass {
                width: 40px;
                height: 50px;
            }

            .love-note-left {
                order: 1;
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                width: 90%;
                max-width: 300px;
                margin: 0 auto 15px auto;
            }

            .love-note-right {
                order: 2;
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                width: 90%;
                max-width: 300px;
                margin: 0 auto 15px auto;
            }

            .music-widget-left {
                order: 10;
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                width: 90%;
                max-width: 300px;
                margin: 15px auto;
            }

            .music-widget-right {
                order: 11;
                position: relative !important;
                left: auto !important;
                right: auto !important;
                top: auto !important;
                width: 90%;
                max-width: 300px;
                margin: 15px auto;
            }
        }

        /* Music Widgets - Below Notes */
        .music-widget-left {
            position: fixed;
            left: 20px;
            top: 310px;
            width: 200px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid #FF0000;
        }

        .music-widget-right {
            position: fixed;
            right: 20px;
            top: 310px;
            width: 200px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            padding: 12px;
            border-radius: 12px;
            box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.2);
            border: 2px solid #1DB954;
        }

        .music-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.85em;
        }

        .music-connect-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            padding: 2px;
            transition: transform 0.2s;
        }

        .music-connect-btn:hover {
            transform: scale(1.2);
        }

        .album-art {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-placeholder {
            font-size: 3em;
            opacity: 0.3;
        }

        .music-info {
            text-align: center;
        }

        .spotify-song {
            font-size: 0.85em;
            color: #333;
            font-weight: 600;
            margin-bottom: 3px;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .spotify-artist {
            font-size: 0.75em;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .spotify-offline {
            font-size: 0.75em;
            color: #999;
            font-style: italic;
            padding: 10px 0;
        }

        .reconnect-btn {
            width: 100%;
            margin-top: 8px;
            padding: 8px;
            font-size: 0.75em;
            background: #1DB954;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .reconnect-btn:hover {
            background: #1ed760;
            transform: none;
        }

        /* Messaging Section */
        .messaging-section {
            background: #fff5f9;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #ffc0cb;
            margin-bottom: 35px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
        }

        .message-bubble {
            display: flex;
            margin-bottom: 15px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-bubble.my-message {
            justify-content: flex-end;
        }

        .message-bubble.their-message {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            position: relative;
        }

        .message-text {
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
            cursor: pointer;
        }

        .my-message .message-text {
            background: linear-gradient(135deg, #ff69b4 0%, #d63384 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .their-message .message-text {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .message-time {
            font-size: 0.7em;
            color: #999;
            margin-top: 4px;
            text-align: right;
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: flex-end;
        }

        .their-message .message-time {
            text-align: left;
            justify-content: flex-start;
        }

        .message-status {
            display: flex;
            align-items: center;
            gap: 3px;
            font-size: 0.9em;
        }

        .status-checkmarks {
            display: inline-flex;
            gap: -2px;
            position: relative;
        }

        .checkmark {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1.5px solid #999;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            transition: all 0.3s;
        }

        .checkmark::before {
            content: '‚úì';
            color: transparent;
        }

        .checkmark.filled {
            border-color: #4a90e2;
            background: #4a90e2;
        }

        .checkmark.filled::before {
            color: white;
        }

        .checkmark.read {
            border-color: #4a90e2;
        }

        .checkmark.read::before {
            color: #4a90e2;
        }

        .status-text {
            font-size: 0.85em;
            color: #999;
            font-style: italic;
        }

        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .reaction-bubble {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .reaction-count {
            font-size: 0.75em;
            color: #666;
        }

        .reaction-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border-radius: 20px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            gap: 5px;
            margin-bottom: 5px;
        }

        .reaction-picker.active {
            display: flex;
        }

        .reaction-option {
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: transform 0.2s;
        }

        .reaction-option:hover {
            transform: scale(1.3);
            background: #f5f5f5;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #ffb3d9;
            border-radius: 20px;
            font-size: 0.95em;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .message-input:focus {
            outline: none;
            border-color: #d63384;
        }

        .send-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff69b4 0%, #d63384 100%);
            color: white;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            padding: 0;
        }

        .send-btn:hover {
            transform: scale(1.1);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: none;
            padding: 10px;
            color: #999;
            font-size: 0.85em;
            font-style: italic;
        }

        .typing-indicator.active {
            display: block;
        }

        .empty-messages {
            text-align: center;
            color: #999;
            padding: 40px 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Setup Modal -->
    <div class="modal" id="setupModal">
        <div class="modal-content">
            <div class="modal-title">üî• Firebase Setup</div>
            <form id="setupForm">
                <div class="setup-info">
                    <strong>Quick Setup:</strong>
                    1. Go to <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a><br>
                    2. Create a new project<br>
                    3. Enable Realtime Database (test mode)<br>
                    4. Get your config from Project Settings ‚Üí Web App<br>
                    5. Paste the 7 values below ‚¨áÔ∏è
                </div>

                <div class="form-group">
                    <label for="firebaseApiKey">API Key:</label>
                    <input type="text" id="firebaseApiKey" required placeholder="AIzaSy...">
                </div>
                <div class="form-group">
                    <label for="firebaseAuthDomain">Auth Domain:</label>
                    <input type="text" id="firebaseAuthDomain" required placeholder="your-app.firebaseapp.com">
                </div>
                <div class="form-group">
                    <label for="firebaseDatabaseURL">Database URL:</label>
                    <input type="text" id="firebaseDatabaseURL" required placeholder="https://your-app.firebaseio.com">
                </div>
                <div class="form-group">
                    <label for="firebaseProjectId">Project ID:</label>
                    <input type="text" id="firebaseProjectId" required placeholder="your-app">
                </div>
                <div class="form-group">
                    <label for="firebaseStorageBucket">Storage Bucket:</label>
                    <input type="text" id="firebaseStorageBucket" required placeholder="your-app.appspot.com">
                </div>
                <div class="form-group">
                    <label for="firebaseMessagingSenderId">Messaging Sender ID:</label>
                    <input type="text" id="firebaseMessagingSenderId" required placeholder="123456789">
                </div>
                <div class="form-group">
                    <label for="firebaseAppId">App ID:</label>
                    <input type="text" id="firebaseAppId" required placeholder="1:123456789:web:abc123">
                </div>

                <button type="submit" style="width: 100%; margin-top: 10px;">Connect üöÄ</button>
                <button type="button" onclick="closeSetupModal()" style="width: 100%; margin-top: 10px; background: #6c757d;">Already Connected? Skip</button>
                
                <div class="setup-info" style="margin-top: 15px;">
                    <strong>‚ö†Ô∏è Share these credentials:</strong> All users must use the SAME Firebase info to see shared tasks!
                </div>
            </form>
        </div>
    </div>

    <div class="container">
        <div id="statusMessage"></div>

        <div class="greeting" id="greeting">
            Good Morning My Loves ü•∞ <span class="sync-indicator"></span>
        </div>

        <!-- Mail Icon - Fixed Position -->
        <button class="mail-btn" onclick="openMessages()" id="mailIcon">
            üì¨
            <span class="unread-badge" id="unreadBadge">0</span>
        </button>

        <!-- Love Note 1 - Left Side -->
        <div class="love-note-left">
            <div id="note1Display" class="note-display"></div>
            <textarea id="note1Input" class="note-input" placeholder="Write a sweet note..." style="display: none;"></textarea>
            <div class="note-footer">
                <button class="note-btn edit-btn" id="note1EditBtn" onclick="editNote(1)">Edit</button>
                <button class="note-btn save-btn" id="note1SaveBtn" onclick="saveNote(1)" style="display: none;">Save</button>
                <button class="note-btn delete-btn" onclick="deleteNote(1)">Clear</button>
            </div>
        </div>

        <!-- YouTube Music Widget - Left Side (Below Note) -->
        <div class="music-widget-left">
            <div class="music-header">
                <span style="color: #FF0000;">üéµ YouTube Music</span>
                <button class="music-connect-btn" onclick="setupYouTubeMusic()">‚öôÔ∏è</button>
            </div>
            <div id="ytMusicAlbum" class="album-art">
                <div class="album-placeholder">üéµ</div>
            </div>
            <div id="spotify1" class="music-info">
                <div class="spotify-offline">Not connected</div>
            </div>
        </div>

        <!-- Love Note 2 - Right Side -->
        <div class="love-note-right">
            <div id="note2Display" class="note-display"></div>
            <textarea id="note2Input" class="note-input" placeholder="Leave another love note..." style="display: none;"></textarea>
            <div class="note-footer">
                <button class="note-btn edit-btn" id="note2EditBtn" onclick="editNote(2)">Edit</button>
                <button class="note-btn save-btn" id="note2SaveBtn" onclick="saveNote(2)" style="display: none;">Save</button>
                <button class="note-btn delete-btn" onclick="deleteNote(2)">Clear</button>
            </div>
        </div>

        <!-- Spotify Widget - Right Side (Below Note) -->
        <div class="music-widget-right">
            <div class="music-header">
                <span style="color: #1DB954;">üéµ Spotify</span>
                <button class="music-connect-btn" onclick="setupSpotify()">‚öôÔ∏è</button>
            </div>
            <div id="spotifyAlbum" class="album-art">
                <div class="album-placeholder">üéµ</div>
            </div>
            <div id="spotify2" class="music-info">
                <div class="spotify-offline">Not connected</div>
            </div>
            <button class="reconnect-btn" id="spotifyReconnectBtn" onclick="reconnectSpotify()" style="display: none;">
                üîÑ Authorize Spotify
            </button>
        </div>

        <!-- Daily Tasks Section -->
        <div class="section">
            <div class="section-title">üìù Today's Tasks</div>
            <div class="task-input-container">
                <input type="text" id="taskInput" placeholder="Add a new task...">
                <button onclick="addTask()">Add Task</button>
            </div>
            <ul class="task-list" id="taskList">
                <div class="loading">Connecting...</div>
            </ul>
        </div>

        <!-- Meal Planning Section -->
        <div class="section">
            <div class="section-title">üçΩÔ∏è Meal Planning</div>
            <div class="task-input-container">
                <input type="text" id="mealInput" placeholder="Add a meal...">
                <button onclick="addMeal()">Add Meal</button>
            </div>
            <ul class="task-list" id="mealList">
                <div class="loading">Loading...</div>
            </ul>
        </div>

        <!-- Water Tracker Section -->
        <div class="section water-tracker">
            <div class="water-reminder">üíß Make sure to drink water!</div>
            
            <!-- Honey Babies Water Tracker -->
            <div style="margin-bottom: 30px;">
                <div style="font-size: 1.1em; color: #c2185b; font-weight: 600; margin-bottom: 10px;">Honey Babies üò°</div>
                <div class="water-glasses" id="waterGlassesBabies"></div>
                <div class="water-count" id="waterCountBabies">0 / 8 glasses</div>
            </div>
            
            <!-- Honey Loves Water Tracker -->
            <div>
                <div style="font-size: 1.1em; color: #c2185b; font-weight: 600; margin-bottom: 10px;">Honey Loves ü•∞</div>
                <div class="water-glasses" id="waterGlassesLoves"></div>
                <div class="water-count" id="waterCountLoves">0 / 8 glasses</div>
            </div>
        </div>

        <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
    </div>

    <!-- Messaging Modal/Page -->
    <div class="messaging-modal" id="messagingModal">
        <div class="messaging-header">
            <button class="back-btn" onclick="closeMessages()">‚Üê</button>
            <div class="chat-info">
                <div class="chat-title">Messages üíï</div>
                <div class="online-status">Both online</div>
            </div>
            <div class="profile-pic-small" id="headerProfilePic" onclick="showUsernames()">
                <div class="profile-placeholder-small">üë§</div>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            <div class="empty-messages">No messages yet. Send the first one! üíï</div>
        </div>
        
        <div class="message-input-area">
            <div class="typing-indicator" id="typingIndicator">typing...</div>
            <div class="message-input-container">
                <textarea id="messageInput" class="message-input" placeholder="Send a message..." rows="1"></textarea>
                <button class="send-btn" onclick="sendMessage()">
                    <span>‚û§</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Username Setup Modal -->
    <div class="username-modal" id="usernameModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title">Your Profile üíï</div>
            
            <div class="profile-picture-section">
                <div class="profile-pic-preview" id="profilePicPreview">
                    <div class="profile-placeholder">üì∑</div>
                </div>
                <input type="file" id="profilePicInput" accept="image/*" style="display: none;" onchange="handleProfilePicChange(event)">
                <button onclick="document.getElementById('profilePicInput').click()" style="width: 100%; margin-top: 10px; background: #ff69b4;">
                    Choose Profile Picture
                </button>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label>Your Name:</label>
                <input type="text" id="usernameInput" placeholder="Enter your name" maxlength="20">
            </div>
            
            <div class="form-group">
                <label>Phone Number (Link Your Account):</label>
                <input type="tel" id="phoneNumberInput" placeholder="+1 (555) 123-4567" maxlength="20">
                <div style="font-size: 0.8em; color: #666; margin-top: 5px; line-height: 1.4;">
                    üì± <strong>Important:</strong> Add your phone number to use the same account on phone AND computer!<br>
                    Without this, each device will have a separate account.
                </div>
            </div>
            
            <button onclick="saveUsername()" style="width: 100%; margin-top: 10px;">Save Profile</button>
        </div>
    </div>

    <!-- Phone Number Login Modal -->
    <div class="username-modal" id="phoneLoginModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-title">Welcome Back! üì±</div>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">
                Enter your phone number to recover your account
            </p>
            
            <div class="form-group">
                <label>Phone Number:</label>
                <input type="tel" id="phoneLoginInput" placeholder="+1 (555) 123-4567" maxlength="20">
            </div>
            
            <button onclick="loginWithPhone()" style="width: 100%; margin-top: 10px;">Continue</button>
            <button onclick="skipPhoneLogin()" style="width: 100%; margin-top: 10px; background: #6c757d;">
                Create New Account
            </button>
        </div>
    </div>

    <!-- Image Cropping Modal -->
    <div class="crop-modal" id="cropModal">
        <div class="crop-modal-content">
            <div class="crop-header">
                <button class="crop-cancel-btn" onclick="cancelCrop()">Cancel</button>
                <div class="crop-title">Move and Scale</div>
                <button class="crop-done-btn" onclick="applyCrop()">Done</button>
            </div>
            <div class="crop-container" id="cropContainer">
                <canvas id="cropCanvas"></canvas>
                <div class="crop-overlay">
                    <div class="crop-circle"></div>
                </div>
            </div>
            <div class="crop-controls">
                <div class="zoom-control">
                    <button onclick="zoomImage(-0.1)">‚àí</button>
                    <input type="range" id="zoomSlider" min="1" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
                    <button onclick="zoomImage(0.1)">+</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let db;
        let firebaseInitialized = false;

        function initFirebase(config) {
            try {
                if (!firebase.apps.length) {
                    firebase.initializeApp(config);
                }
                db = firebase.database();
                firebaseInitialized = true;
                showStatus('Connected! All users will see the same data üî•', 'success');
                setupRealtimeListeners();
                return true;
            } catch (error) {
                showStatus('Connection failed: ' + error.message, 'error');
                return false;
            }
        }

        function setupRealtimeListeners() {
            const dateKey = getTodayKey();
            
            db.ref(`tasks/${dateKey}`).on('value', (snapshot) => {
                displayTasks(snapshot.val() || {});
            });
            
            db.ref(`meals/${dateKey}`).on('value', (snapshot) => {
                displayMeals(snapshot.val() || {});
            });
            
            // Listen to Honey Babies water tracker
            db.ref(`water_babies/${dateKey}`).on('value', (snapshot) => {
                displayWaterTracker('babies', snapshot.val() || Array(8).fill(false));
            });
            
            // Listen to Honey Loves water tracker
            db.ref(`water_loves/${dateKey}`).on('value', (snapshot) => {
                displayWaterTracker('loves', snapshot.val() || Array(8).fill(false));
            });
            
            // Listen to love notes
            db.ref(`love_notes/${dateKey}/note1`).on('value', (snapshot) => {
                displayNote(1, snapshot.val() || '');
            });
            
            db.ref(`love_notes/${dateKey}/note2`).on('value', (snapshot) => {
                displayNote(2, snapshot.val() || '');
            });
        }

        function getTodayKey() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        function checkSetup() {
            const config = localStorage.getItem('firebase_config');
            if (!config) {
                document.getElementById('setupModal').classList.add('active');
                return false;
            }
            try {
                const parsed = JSON.parse(config);
                // Verify all required fields are present
                if (!parsed.apiKey || !parsed.databaseURL || !parsed.projectId) {
                    document.getElementById('setupModal').classList.add('active');
                    return false;
                }
                return initFirebase(parsed);
            } catch (error) {
                document.getElementById('setupModal').classList.add('active');
                return false;
            }
        }

        function closeSetupModal() {
            // Only allow closing if Firebase is already initialized
            if (firebaseInitialized) {
                document.getElementById('setupModal').classList.remove('active');
            } else {
                showStatus('Please connect to Firebase first', 'error');
            }
        }

        document.getElementById('setupForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const config = {
                apiKey: document.getElementById('firebaseApiKey').value.trim(),
                authDomain: document.getElementById('firebaseAuthDomain').value.trim(),
                databaseURL: document.getElementById('firebaseDatabaseURL').value.trim(),
                projectId: document.getElementById('firebaseProjectId').value.trim(),
                storageBucket: document.getElementById('firebaseStorageBucket').value.trim(),
                messagingSenderId: document.getElementById('firebaseMessagingSenderId').value.trim(),
                appId: document.getElementById('firebaseAppId').value.trim()
            };

            // Save to localStorage with backup
            const configString = JSON.stringify(config);
            localStorage.setItem('firebase_config', configString);
            
            // Also save to sessionStorage as backup
            sessionStorage.setItem('firebase_config_backup', configString);
            
            // Add a timestamp to track when it was saved
            localStorage.setItem('firebase_config_saved', new Date().toISOString());

            if (initFirebase(config)) {
                document.getElementById('setupModal').classList.remove('active');
                updateGreeting();
                showStatus('Setup saved! You won\'t need to do this again. üéâ', 'success');
            }
        });

        function openSettings() {
            document.getElementById('setupModal').classList.add('active');
            const config = JSON.parse(localStorage.getItem('firebase_config') || '{}');
            document.getElementById('firebaseApiKey').value = config.apiKey || '';
            document.getElementById('firebaseAuthDomain').value = config.authDomain || '';
            document.getElementById('firebaseDatabaseURL').value = config.databaseURL || '';
            document.getElementById('firebaseProjectId').value = config.projectId || '';
            document.getElementById('firebaseStorageBucket').value = config.storageBucket || '';
            document.getElementById('firebaseMessagingSenderId').value = config.messagingSenderId || '';
            document.getElementById('firebaseAppId').value = config.appId || '';
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.className = `status-message ${type}`;
            statusEl.textContent = message;
            if (type === 'success') {
                setTimeout(() => statusEl.innerHTML = '', 3000);
            }
        }

        function updateGreeting() {
            const hour = new Date().getHours();
            const greetingEl = document.getElementById('greeting');
            
            let text = '';
            if (hour < 12) {
                text = 'Good Morning My Loves ü•∞';
            } else if (hour < 17) {
                text = 'Good Afternoon Honey Bunnies ü•∞';
            } else {
                text = 'Hi My Loves ü•∞';
            }
            
            greetingEl.innerHTML = text + ' <span class="sync-indicator"></span>';
        }

        async function addTask() {
            if (!firebaseInitialized) return;
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text) return;
            
            try {
                await db.ref(`tasks/${getTodayKey()}/${Date.now()}`).set({
                    text: text,
                    completed: false,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
            } catch (error) {
                showStatus('Failed to add task', 'error');
            }
        }

        async function toggleTask(taskId) {
            if (!firebaseInitialized) return;
            const taskRef = db.ref(`tasks/${getTodayKey()}/${taskId}`);
            const snapshot = await taskRef.once('value');
            const task = snapshot.val();
            if (task) {
                await taskRef.update({ completed: !task.completed });
            }
        }

        async function deleteTask(taskId) {
            if (!firebaseInitialized) return;
            await db.ref(`tasks/${getTodayKey()}/${taskId}`).remove();
        }

        function displayTasks(tasksObj) {
            const taskList = document.getElementById('taskList');
            const tasks = Object.entries(tasksObj).map(([id, task]) => ({ id, ...task }));
            
            // Check for new tasks and send notification
            checkForNewTasks(tasksObj);
            
            if (tasks.length === 0) {
                taskList.innerHTML = '<div class="empty-state">No tasks yet. Add your first task above!</div>';
                return;
            }
            
            taskList.innerHTML = tasks.map(task => `
                <li class="task-item ${task.completed ? 'completed' : ''}">
                    <input type="checkbox" ${task.completed ? 'checked' : ''} 
                           onchange="toggleTask('${task.id}')">
                    <span class="task-text">${escapeHtml(task.text)}</span>
                    <button class="delete-btn" onclick="deleteTask('${task.id}')">Delete</button>
                </li>
            `).join('');
        }

        async function addMeal() {
            if (!firebaseInitialized) return;
            const input = document.getElementById('mealInput');
            const text = input.value.trim();
            if (!text) return;
            
            try {
                await db.ref(`meals/${getTodayKey()}/${Date.now()}`).set({
                    text: text,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                });
                input.value = '';
            } catch (error) {
                showStatus('Failed to add meal', 'error');
            }
        }

        async function deleteMeal(mealId) {
            if (!firebaseInitialized) return;
            await db.ref(`meals/${getTodayKey()}/${mealId}`).remove();
        }

        function displayMeals(mealsObj) {
            const mealList = document.getElementById('mealList');
            const meals = Object.entries(mealsObj).map(([id, meal]) => ({ id, ...meal }));
            
            // Check for new meals and send notification
            checkForNewMeals(mealsObj);
            
            if (meals.length === 0) {
                mealList.innerHTML = '<div class="empty-state">No meals planned yet. Add your first meal above!</div>';
                return;
            }
            
            mealList.innerHTML = meals.map(meal => `
                <li class="task-item">
                    <span class="task-text">${escapeHtml(meal.text)}</span>
                    <button class="delete-btn" onclick="deleteMeal('${meal.id}')">Delete</button>
                </li>
            `).join('');
        }

        function initWaterGlasses() {
            // Initialize Honey Babies water glasses
            const containerBabies = document.getElementById('waterGlassesBabies');
            containerBabies.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const glass = document.createElement('div');
                glass.className = 'water-glass';
                glass.onclick = () => toggleWaterGlass('babies', i);
                containerBabies.appendChild(glass);
            }
            
            // Initialize Honey Loves water glasses
            const containerLoves = document.getElementById('waterGlassesLoves');
            containerLoves.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const glass = document.createElement('div');
                glass.className = 'water-glass';
                glass.onclick = () => toggleWaterGlass('loves', i);
                containerLoves.appendChild(glass);
            }
        }

        async function toggleWaterGlass(person, index) {
            if (!firebaseInitialized) return;
            const dateKey = getTodayKey();
            const waterKey = `water_${person}`;
            
            const snapshot = await db.ref(`${waterKey}/${dateKey}`).once('value');
            let waterData = snapshot.val() || Array(8).fill(false);
            if (!Array.isArray(waterData) || waterData.length !== 8) {
                waterData = Array(8).fill(false);
            }
            waterData[index] = !waterData[index];
            await db.ref(`${waterKey}/${dateKey}`).set(waterData);
        }

        function displayWaterTracker(person, waterData) {
            if (!Array.isArray(waterData) || waterData.length !== 8) {
                waterData = Array(8).fill(false);
            }
            
            const containerId = person === 'babies' ? 'waterGlassesBabies' : 'waterGlassesLoves';
            const countId = person === 'babies' ? 'waterCountBabies' : 'waterCountLoves';
            
            const glasses = document.querySelectorAll(`#${containerId} .water-glass`);
            glasses.forEach((glass, index) => {
                if (waterData[index]) {
                    glass.classList.add('filled');
                } else {
                    glass.classList.remove('filled');
                }
            });
            const count = waterData.filter(g => g).length;
            document.getElementById(countId).textContent = `${count} / 8 glasses`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // === MESSAGING SYSTEM ===
        let currentUserId = localStorage.getItem('user_id') || null;
        let currentUsername = localStorage.getItem('username') || '';
        let currentProfilePic = localStorage.getItem('profile_pic') || '';
        let currentPhoneNumber = localStorage.getItem('phone_number') || '';
        let lastMessageCount = 0;
        let lastReadTimestamp = parseInt(localStorage.getItem('last_read_timestamp') || '0');
        let isAccountLinked = localStorage.getItem('account_linked') === 'true';

        // Check if user needs to log in with phone or create new account
        async function checkUserLogin() {
            // If no user ID at all, show phone login
            if (!currentUserId) {
                document.getElementById('phoneLoginModal').classList.add('active');
                return;
            }
            
            // If user has ID but hasn't linked to phone yet, prompt them
            if (!isAccountLinked && !currentPhoneNumber) {
                setTimeout(() => {
                    const linkAccount = confirm(
                        "üí° Link Your Account!\n\n" +
                        "Link your account with a phone number so you can:\n" +
                        "‚úÖ Use the same account on multiple devices\n" +
                        "‚úÖ Recover your account if you reinstall\n\n" +
                        "Would you like to link your account now?"
                    );
                    
                    if (linkAccount) {
                        showUsernames(); // Opens profile modal where they can add phone
                    } else {
                        localStorage.setItem('account_linked', 'true'); // Don't ask again
                    }
                }, 3000); // Wait 3 seconds after app loads
            }
        }

        async function loginWithPhone() {
            const phone = document.getElementById('phoneLoginInput').value.trim();
            if (!phone) {
                alert('Please enter your phone number');
                return;
            }
            
            if (!firebaseInitialized) {
                alert('Please wait for Firebase to connect...');
                return;
            }
            
            try {
                // Search for user with this phone number
                const snapshot = await db.ref('phoneNumbers').once('value');
                const allPhones = snapshot.val() || {};
                
                let foundUserId = null;
                let foundUserData = null;
                
                // Search through all phone numbers
                for (const [userId, data] of Object.entries(allPhones)) {
                    if (data.phoneNumber === phone) {
                        foundUserId = userId;
                        foundUserData = data;
                        break;
                    }
                }
                
                if (foundUserId) {
                    // Found account!
                    currentUserId = foundUserId;
                    currentUsername = foundUserData.username || '';
                    currentProfilePic = foundUserData.profilePic || '';
                    currentPhoneNumber = phone;
                    
                    // Save locally
                    localStorage.setItem('user_id', currentUserId);
                    localStorage.setItem('username', currentUsername);
                    localStorage.setItem('profile_pic', currentProfilePic);
                    localStorage.setItem('phone_number', phone);
                    localStorage.setItem('account_linked', 'true');
                    
                    loadProfilePicPreview();
                    document.getElementById('phoneLoginModal').classList.remove('active');
                    
                    alert('‚úÖ Welcome back, ' + currentUsername + '! ü•∞');
                    
                    // Reload page to refresh everything
                    setTimeout(() => location.reload(), 500);
                } else {
                    const createNew = confirm(
                        "No account found with this phone number.\n\n" +
                        "Would you like to create a new account with this number?"
                    );
                    
                    if (createNew) {
                        skipPhoneLogin();
                        // Pre-fill phone number
                        setTimeout(() => {
                            document.getElementById('phoneNumberInput').value = phone;
                        }, 500);
                    }
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Error logging in. Please try again.');
            }
        }

        function skipPhoneLogin() {
            // Create new user ID
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('user_id', currentUserId);
            
            document.getElementById('phoneLoginModal').classList.remove('active');
            
            // Prompt for profile setup
            setTimeout(() => {
                document.getElementById('usernameModal').classList.add('active');
            }, 500);
        }

        // Function to manually link existing account to phone
        async function linkPhoneToAccount(phone) {
            if (!currentUserId || !phone) return;
            
            try {
                // Save phone number mapping
                await db.ref(`phoneNumbers/${currentUserId}`).set({
                    phoneNumber: phone,
                    username: currentUsername,
                    profilePic: currentProfilePic || null,
                    userId: currentUserId,
                    linkedAt: firebase.database.ServerValue.TIMESTAMP
                });
                
                localStorage.setItem('phone_number', phone);
                localStorage.setItem('account_linked', 'true');
                
                console.log('Account linked to phone:', phone);
                return true;
            } catch (error) {
                console.error('Error linking phone:', error);
                return false;
            }
        }

        let cropImage = null;
        let cropScale = 1;
        let initialScale = 1;
        let cropX = 0;
        let cropY = 0;
        let isDragging = false;
        let lastX = 0;
        let lastY = 0;

        function handleProfilePicChange(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image too large! Please choose an image under 5MB.');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file.');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    cropImage = img;
                    openCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function openCropModal() {
            document.getElementById('cropModal').classList.add('active');
            document.getElementById('usernameModal').style.display = 'none';
            
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set canvas size
            const maxSize = Math.min(window.innerWidth, window.innerHeight * 0.6);
            canvas.width = maxSize;
            canvas.height = maxSize;
            
            // Calculate initial scale - FIT the image so entire image is visible
            // Don't zoom in, let user zoom if they want
            const scaleX = maxSize / cropImage.width;
            const scaleY = maxSize / cropImage.height;
            initialScale = Math.min(scaleX, scaleY) * 0.9; // 0.9 to add some padding
            cropScale = initialScale;
            
            // Center the image
            cropX = (maxSize - cropImage.width * cropScale) / 2;
            cropY = (maxSize - cropImage.height * cropScale) / 2;
            
            // Reset zoom slider
            document.getElementById('zoomSlider').value = 1;
            
            drawCropCanvas();
            setupCropDrag();
        }

        function drawCropCanvas() {
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(cropImage, cropX, cropY, cropImage.width * cropScale, cropImage.height * cropScale);
        }

        function setupCropDrag() {
            const canvas = document.getElementById('cropCanvas');
            
            canvas.addEventListener('mousedown', startDrag);
            canvas.addEventListener('mousemove', drag);
            canvas.addEventListener('mouseup', stopDrag);
            canvas.addEventListener('mouseleave', stopDrag);
            
            canvas.addEventListener('touchstart', startDrag);
            canvas.addEventListener('touchmove', drag);
            canvas.addEventListener('touchend', stopDrag);
        }

        function startDrag(e) {
            isDragging = true;
            const pos = getEventPosition(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function drag(e) {
            if (!isDragging) return;
            e.preventDefault();
            
            const pos = getEventPosition(e);
            const dx = pos.x - lastX;
            const dy = pos.y - lastY;
            
            cropX += dx;
            cropY += dy;
            
            lastX = pos.x;
            lastY = pos.y;
            
            drawCropCanvas();
        }

        function stopDrag() {
            isDragging = false;
        }

        function getEventPosition(e) {
            const canvas = document.getElementById('cropCanvas');
            const rect = canvas.getBoundingClientRect();
            
            if (e.touches && e.touches[0]) {
                return {
                    x: e.touches[0].clientX - rect.left,
                    y: e.touches[0].clientY - rect.top
                };
            }
            return {
                x: e.clientX - rect.left,
                y: e.clientY - rect.top
            };
        }

        function updateZoom(value) {
            const zoomMultiplier = parseFloat(value);
            const oldScale = cropScale;
            cropScale = initialScale * zoomMultiplier; // Zoom relative to initial scale
            
            // Adjust position to zoom from center
            const canvas = document.getElementById('cropCanvas');
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            cropX = centerX - (centerX - cropX) * (cropScale / oldScale);
            cropY = centerY - (centerY - cropY) * (cropScale / oldScale);
            
            drawCropCanvas();
        }

        function zoomImage(delta) {
            const slider = document.getElementById('zoomSlider');
            const newValue = Math.max(1, Math.min(3, parseFloat(slider.value) + delta));
            slider.value = newValue;
            updateZoom(newValue);
        }

        function applyCrop() {
            const canvas = document.getElementById('cropCanvas');
            const outputCanvas = document.createElement('canvas');
            const outputSize = 300;
            outputCanvas.width = outputSize;
            outputCanvas.height = outputSize;
            const outputCtx = outputCanvas.getContext('2d');
            
            // Calculate circle center and radius
            const circleRadius = 140; // 280px diameter / 2
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            // Create circular clip path
            outputCtx.beginPath();
            outputCtx.arc(outputSize / 2, outputSize / 2, outputSize / 2, 0, Math.PI * 2);
            outputCtx.closePath();
            outputCtx.clip();
            
            // Calculate scale to fit circle
            const scale = outputSize / (circleRadius * 2);
            const sourceX = (centerX - circleRadius - cropX) / cropScale;
            const sourceY = (centerY - circleRadius - cropY) / cropScale;
            const sourceSize = (circleRadius * 2) / cropScale;
            
            outputCtx.drawImage(
                cropImage,
                sourceX,
                sourceY,
                sourceSize,
                sourceSize,
                0,
                0,
                outputSize,
                outputSize
            );
            
            // Convert to data URL
            const croppedImage = outputCanvas.toDataURL('image/jpeg', 0.9);
            currentProfilePic = croppedImage;
            
            // Show preview
            document.getElementById('profilePicPreview').innerHTML = `<img src="${croppedImage}" alt="Profile">`;
            
            // Close crop modal and reopen username modal
            closeCropModal();
        }

        function cancelCrop() {
            closeCropModal();
        }

        function closeCropModal() {
            document.getElementById('cropModal').classList.remove('active');
            document.getElementById('usernameModal').style.display = 'flex';
            document.getElementById('profilePicInput').value = '';
        }

        function loadProfilePicPreview() {
            if (currentProfilePic) {
                document.getElementById('profilePicPreview').innerHTML = `<img src="${currentProfilePic}" alt="Profile">`;
            }
            
            // Load header profile pic
            if (currentProfilePic) {
                document.getElementById('headerProfilePic').innerHTML = `<img src="${currentProfilePic}" alt="Profile">`;
            }
        }

        function openMessages() {
            document.getElementById('messagingModal').classList.add('active');
            // Mark as read
            lastReadTimestamp = Date.now();
            localStorage.setItem('last_read_timestamp', lastReadTimestamp.toString());
            updateUnreadCount();
            
            // Check if user has set their name
            if (!currentUsername) {
                setTimeout(() => {
                    document.getElementById('usernameModal').classList.add('active');
                }, 500);
            }
        }

        function closeMessages() {
            document.getElementById('messagingModal').classList.remove('active');
        }

        function showUsernames() {
            document.getElementById('usernameModal').classList.add('active');
        }

        async function saveUsername() {
            const input = document.getElementById('usernameInput');
            const name = input.value.trim();
            const phone = document.getElementById('phoneNumberInput').value.trim();
            
            if (name) {
                currentUsername = name;
                localStorage.setItem('username', name);
                
                // Save profile pic if set
                if (currentProfilePic) {
                    localStorage.setItem('profile_pic', currentProfilePic);
                }
                
                // Save to Firebase
                if (firebaseInitialized) {
                    await db.ref(`users/${currentUserId}`).set({
                        name: name,
                        profilePic: currentProfilePic || null,
                        lastSeen: firebase.database.ServerValue.TIMESTAMP
                    });
                    
                    // Link phone number if provided
                    if (phone) {
                        currentPhoneNumber = phone;
                        await linkPhoneToAccount(phone);
                        alert('‚úÖ Account linked to ' + phone + '!\n\nYou can now log in from any device with this number.');
                    }
                }
                
                loadProfilePicPreview();
                document.getElementById('usernameModal').classList.remove('active');
                input.value = '';
                document.getElementById('phoneNumberInput').value = '';
            }
        }

        function updateUnreadCount() {
            if (!firebaseInitialized) return;
            
            db.ref('messages').once('value', (snapshot) => {
                const messages = snapshot.val() || {};
                let unreadCount = 0;
                
                Object.values(messages).forEach(msg => {
                    if (msg.timestamp > lastReadTimestamp && msg.userId !== currentUserId) {
                        unreadCount++;
                    }
                });
                
                const badge = document.getElementById('unreadBadge');
                if (badge) {
                    badge.textContent = unreadCount;
                    badge.setAttribute('data-count', unreadCount);
                }
            });
        }

        async function sendMessage() {
            if (!firebaseInitialized) return;
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text) return;
            
            if (!currentUsername) {
                alert('Please set your name first!');
                showUsernames();
                return;
            }
            
            try {
                const messageId = Date.now().toString();
                await db.ref(`messages/${messageId}`).set({
                    text: text,
                    userId: currentUserId,
                    username: currentUsername,
                    profilePic: currentProfilePic || null,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    reactions: {},
                    status: 'delivered',
                    readBy: []
                });
                
                input.value = '';
                input.style.height = 'auto';
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function displayMessages(messagesObj) {
            const container = document.getElementById('messagesContainer');
            const messages = Object.entries(messagesObj || {}).map(([id, msg]) => ({ id, ...msg }));
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-messages">No messages yet. Send the first one! üíï</div>';
                return;
            }
            
            // Sort by timestamp
            messages.sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
            
            // Mark messages as read when viewing
            messages.forEach(msg => {
                if (msg.userId !== currentUserId && msg.id) {
                    const readBy = msg.readBy || [];
                    if (!readBy.includes(currentUserId)) {
                        // Mark as read
                        db.ref(`messages/${msg.id}/readBy`).once('value', (snapshot) => {
                            const current = snapshot.val() || [];
                            if (!current.includes(currentUserId)) {
                                db.ref(`messages/${msg.id}/readBy`).set([...current, currentUserId]);
                            }
                        });
                    }
                }
            });
            
            // Check for new messages from other person (for notifications)
            const lastMessage = messages[messages.length - 1];
            if (lastMessage && 
                lastMessage.userId !== currentUserId && 
                lastMessage.timestamp > lastReadTimestamp) {
                // New message from other person!
                sendLocalNotification(
                    `üí¨ ${lastMessage.username || 'New Message'}`, 
                    lastMessage.text.substring(0, 100)
                );
            }
            
            container.innerHTML = messages.map(msg => {
                const isMine = msg.userId === currentUserId;
                const time = msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
                const senderName = msg.username || 'Unknown';
                
                // Determine message status
                let statusHtml = '';
                if (isMine) {
                    const readBy = msg.readBy || [];
                    const isRead = readBy.length > 1 || (readBy.length === 1 && readBy[0] !== currentUserId);
                    
                    if (isRead) {
                        // Read by other person - filled blue checkmarks
                        statusHtml = `
                            <div class="message-status">
                                <div class="status-checkmarks">
                                    <div class="checkmark filled"></div>
                                    <div class="checkmark filled"></div>
                                </div>
                                <span class="status-text">Read</span>
                            </div>
                        `;
                    } else {
                        // Delivered but not read - outline checkmarks
                        statusHtml = `
                            <div class="message-status">
                                <div class="status-checkmarks">
                                    <div class="checkmark read"></div>
                                    <div class="checkmark read"></div>
                                </div>
                                <span class="status-text">Delivered</span>
                            </div>
                        `;
                    }
                }
                
                const reactionsHtml = msg.reactions ? Object.entries(msg.reactions)
                    .reduce((acc, [emoji, users]) => {
                        const count = Array.isArray(users) ? users.length : (users ? 1 : 0);
                        if (count > 0) {
                            acc.push(`<div class="reaction-bubble">${emoji} <span class="reaction-count">${count}</span></div>`);
                        }
                        return acc;
                    }, []).join('') : '';
                
                return `
                    <div class="message-bubble ${isMine ? 'my-message' : 'their-message'}">
                        ${!isMine && msg.profilePic ? `
                            <div class="message-profile-pic">
                                <img src="${msg.profilePic}" alt="${escapeHtml(senderName)}">
                            </div>
                        ` : ''}
                        <div class="message-content">
                            ${!isMine ? `<div class="sender-name">${escapeHtml(senderName)}</div>` : ''}
                            <div class="message-text" onclick="toggleReactionPicker('${msg.id}')" oncontextmenu="toggleReactionPicker('${msg.id}'); return false;">
                                ${escapeHtml(msg.text)}
                                <div class="reaction-picker" id="picker-${msg.id}">
                                    <span class="reaction-option" onclick="addReaction('${msg.id}', '‚ù§Ô∏è'); event.stopPropagation();">‚ù§Ô∏è</span>
                                    <span class="reaction-option" onclick="addReaction('${msg.id}', 'üòÇ'); event.stopPropagation();">üòÇ</span>
                                    <span class="reaction-option" onclick="addReaction('${msg.id}', 'üòç'); event.stopPropagation();">üòç</span>
                                    <span class="reaction-option" onclick="addReaction('${msg.id}', 'ü•∞'); event.stopPropagation();">ü•∞</span>
                                    <span class="reaction-option" onclick="addReaction('${msg.id}', 'üëç'); event.stopPropagation();">üëç</span>
                                    <span class="reaction-option" onclick="addReaction('${msg.id}', 'üò¢'); event.stopPropagation();">üò¢</span>
                                </div>
                            </div>
                            ${reactionsHtml ? `<div class="message-reactions">${reactionsHtml}</div>` : ''}
                            <div class="message-time">
                                ${time}
                                ${statusHtml}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        function toggleReactionPicker(messageId) {
            const picker = document.getElementById(`picker-${messageId}`);
            if (picker) {
                // Close all other pickers
                document.querySelectorAll('.reaction-picker').forEach(p => {
                    if (p.id !== `picker-${messageId}`) {
                        p.classList.remove('active');
                    }
                });
                picker.classList.toggle('active');
            }
        }

        async function addReaction(messageId, emoji) {
            if (!firebaseInitialized) return;
            
            try {
                const reactionRef = db.ref(`messages/${messageId}/reactions/${emoji}`);
                const snapshot = await reactionRef.once('value');
                let users = snapshot.val() || [];
                
                if (!Array.isArray(users)) users = [];
                
                if (users.includes(currentUserId)) {
                    // Remove reaction
                    users = users.filter(id => id !== currentUserId);
                } else {
                    // Add reaction
                    users.push(currentUserId);
                }
                
                await reactionRef.set(users.length > 0 ? users : null);
                
                // Close picker
                document.getElementById(`picker-${messageId}`)?.classList.remove('active');
            } catch (error) {
                console.error('Error adding reaction:', error);
            }
        }

        function setupMessagingListeners() {
            if (!firebaseInitialized) return;
            
            db.ref('messages').on('value', (snapshot) => {
                displayMessages(snapshot.val());
                updateUnreadCount();
            });
        }

        // Auto-resize message input
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
                
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            const usernameInput = document.getElementById('usernameInput');
            if (usernameInput) {
                usernameInput.value = currentUsername;
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        saveUsername();
                    }
                });
            }
            
            // Load profile picture preview
            loadProfilePicPreview();
            
            // Update unread count periodically
            setInterval(updateUnreadCount, 5000);
        });

        // Love Notes Functions
        function editNote(noteNum) {
            const display = document.getElementById(`note${noteNum}Display`);
            const input = document.getElementById(`note${noteNum}Input`);
            const editBtn = document.getElementById(`note${noteNum}EditBtn`);
            const saveBtn = document.getElementById(`note${noteNum}SaveBtn`);
            
            // Switch to edit mode
            input.value = display.textContent;
            display.style.display = 'none';
            input.style.display = 'block';
            editBtn.style.display = 'none';
            saveBtn.style.display = 'inline-block';
            input.focus();
        }

        async function saveNote(noteNum) {
            if (!firebaseInitialized) return;
            
            const input = document.getElementById(`note${noteNum}Input`);
            const text = input.value.trim();
            
            try {
                await db.ref(`love_notes/${getTodayKey()}/note${noteNum}`).set(text);
                
                // Switch back to display mode
                const display = document.getElementById(`note${noteNum}Display`);
                const editBtn = document.getElementById(`note${noteNum}EditBtn`);
                const saveBtn = document.getElementById(`note${noteNum}SaveBtn`);
                
                display.style.display = 'block';
                input.style.display = 'none';
                editBtn.style.display = 'inline-block';
                saveBtn.style.display = 'none';
            } catch (error) {
                showStatus('Failed to save note', 'error');
            }
        }

        async function deleteNote(noteNum) {
            if (!firebaseInitialized) return;
            await db.ref(`love_notes/${getTodayKey()}/note${noteNum}`).set('');
        }

        function displayNote(noteNum, text) {
            const display = document.getElementById(`note${noteNum}Display`);
            const input = document.getElementById(`note${noteNum}Input`);
            
            if (text) {
                display.textContent = text;
            } else {
                display.innerHTML = '<span style="color: #999; font-style: italic;">No note yet... Click Edit to write one! üíï</span>';
            }
            
            // Make sure we're in display mode
            display.style.display = 'block';
            input.style.display = 'none';
        }

        // Music Integration
        let youtubeToken = localStorage.getItem('youtube_music_token');
        let spotifyToken = localStorage.getItem('spotify_token');

        // === YOUTUBE MUSIC SETUP (Left Side - Person 1) ===
        function setupYouTubeMusic() {
            const lastfmApiKey = localStorage.getItem('lastfm_api_key');
            const lastfmUsername = localStorage.getItem('lastfm_username');
            
            if (!lastfmApiKey || !lastfmUsername) {
                alert(
                    'YouTube Music Real-Time Setup:\n\n' +
                    'Since YouTube Music doesn\'t have a public API, we\'ll use Last.fm!\n\n' +
                    'STEP 1: Create Last.fm Account\n' +
                    '1. Go to: https://www.last.fm/join\n' +
                    '2. Create a free account\n' +
                    '3. Remember your username!\n\n' +
                    'STEP 2: Get API Key\n' +
                    '1. Go to: https://www.last.fm/api/account/create\n' +
                    '2. Application name: "Daily Tracker"\n' +
                    '3. Description: "Couple\'s tracker"\n' +
                    '4. Copy your API Key\n\n' +
                    'STEP 3: Install Web Scrobbler\n' +
                    '1. Install browser extension: https://web-scrobbler.com\n' +
                    '2. Connect it to your Last.fm account\n' +
                    '3. It will auto-track YouTube Music!\n\n' +
                    'Click OK to enter your details now!'
                );
                
                const username = prompt('Enter your Last.fm username:');
                if (!username) return;
                
                const apiKey = prompt('Enter your Last.fm API Key:');
                if (!apiKey) return;
                
                localStorage.setItem('lastfm_username', username.trim());
                localStorage.setItem('lastfm_api_key', apiKey.trim());
                
                alert('Setup complete! üéµ\n\nMake sure Web Scrobbler extension is installed and connected.\nYour music will now update automatically!');
                
                // Fetch immediately
                fetchYouTubeMusicNowPlaying();
            } else {
                // Already set up - show current config
                const response = confirm(
                    'YouTube Music is already connected!\n\n' +
                    'Username: ' + lastfmUsername + '\n\n' +
                    'Click OK to reconfigure, or Cancel to keep current setup.'
                );
                
                if (response) {
                    localStorage.removeItem('lastfm_username');
                    localStorage.removeItem('lastfm_api_key');
                    setupYouTubeMusic();
                }
            }
        }

        // === SPOTIFY SETUP (Right Side - Person 2) ===
        
        // Generate code verifier and challenge for PKCE
        function generateCodeVerifier() {
            const array = new Uint8Array(32);
            crypto.getRandomValues(array);
            return base64URLEncode(array);
        }

        function base64URLEncode(buffer) {
            return btoa(String.fromCharCode.apply(null, buffer))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function generateCodeChallenge(verifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(verifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            return base64URLEncode(new Uint8Array(hash));
        }

        function setupSpotify() {
            const clientId = localStorage.getItem('spotify_client_id');
            
            if (!clientId) {
                const newClientId = prompt(
                    'Spotify Setup - Step 1:\n\n' +
                    '1. Go to: https://developer.spotify.com/dashboard\n' +
                    '2. Log in with your Spotify account\n' +
                    '3. Click "Create app"\n' +
                    '4. App name: "Daily Tracker"\n' +
                    '5. App description: "Couple\'s daily tracker"\n' +
                    '6. Redirect URI: https://pk1495.github.io/Tracker-app/callback\n' +
                    '   (Copy this EXACTLY!)\n' +
                    '7. Check "Web API"\n' +
                    '8. Save and copy your Client ID\n\n' +
                    'Paste your Client ID here:'
                );
                
                if (newClientId) {
                    localStorage.setItem('spotify_client_id', newClientId.trim());
                    alert('Client ID saved!\n\nNow click the "üîÑ Authorize Spotify" button to connect your account.');
                    document.getElementById('spotifyReconnectBtn').style.display = 'block';
                }
                return;
            }
            
            const response = confirm(
                'Spotify Client ID is already set.\n\n' +
                'Click OK to enter a new Client ID\n' +
                'Click Cancel to authorize with current ID'
            );
            
            if (response) {
                localStorage.removeItem('spotify_client_id');
                localStorage.removeItem('spotify_token');
                setupSpotify();
            } else {
                reconnectSpotify();
            }
        }

        async function reconnectSpotify() {
            const clientId = localStorage.getItem('spotify_client_id');
            
            if (!clientId) {
                alert('No Client ID found. Please click the ‚öôÔ∏è gear icon first to set up Spotify.');
                return;
            }
            
            // Generate PKCE values
            const codeVerifier = generateCodeVerifier();
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            
            // Store verifier for later
            sessionStorage.setItem('spotify_code_verifier', codeVerifier);
            
            // Build authorization URL with PKCE
            const redirectUri = 'https://pk1495.github.io/Tracker-app/callback';
            const scope = 'user-read-currently-playing user-read-playback-state';
            const state = Math.random().toString(36).substring(7);
            
            sessionStorage.setItem('spotify_auth_state', state);
            
            const authUrl = `https://accounts.spotify.com/authorize?` +
                `client_id=${clientId}` +
                `&response_type=code` +
                `&redirect_uri=${encodeURIComponent(redirectUri)}` +
                `&scope=${encodeURIComponent(scope)}` +
                `&state=${state}` +
                `&code_challenge_method=S256` +
                `&code_challenge=${codeChallenge}`;
            
            console.log('Redirecting to Spotify with PKCE...');
            window.location.href = authUrl;
        }

        // Check for Spotify token in URL (after OAuth redirect)
        function checkSpotifyToken() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            
            if (token) {
                localStorage.setItem('spotify_token', token);
                spotifyToken = token;
                
                // Clear the hash
                window.history.replaceState(null, null, window.location.pathname);
                
                showStatus('Spotify connected! üéµ', 'success');
                
                // Immediately fetch current playing
                fetchSpotifyNowPlaying();
            }
        }

        // === FETCH YOUTUBE MUSIC (Left Side) ===
        async function fetchYouTubeMusicNowPlaying() {
            const lastfmApiKey = localStorage.getItem('lastfm_api_key');
            const lastfmUsername = localStorage.getItem('lastfm_username');
            
            if (!lastfmApiKey || !lastfmUsername) {
                // Not configured - check Firebase for updates from other device
                if (firebaseInitialized) {
                    const snapshot = await db.ref('music/youtube').once('value');
                    const data = snapshot.val();
                    
                    if (data && data.song) {
                        document.getElementById('spotify1').innerHTML = `
                            <div class="spotify-song">${escapeHtml(data.song)}</div>
                            <div class="spotify-artist">${escapeHtml(data.artist || '')}</div>
                        `;
                        
                        // Show album art if available
                        if (data.albumArt) {
                            document.getElementById('ytMusicAlbum').innerHTML = `<img src="${data.albumArt}" alt="Album">`;
                        }
                        return;
                    }
                }
                
                document.getElementById('spotify1').innerHTML = '<div class="spotify-offline">Not connected</div>';
                document.getElementById('ytMusicAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                return;
            }
            
            try {
                // Fetch recent tracks from Last.fm
                const response = await fetch(
                    `https://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=${lastfmUsername}&api_key=${lastfmApiKey}&format=json&limit=1`
                );
                
                if (!response.ok) {
                    throw new Error('Last.fm API error');
                }
                
                const data = await response.json();
                
                if (data.recenttracks && data.recenttracks.track && data.recenttracks.track.length > 0) {
                    const track = data.recenttracks.track[0];
                    const song = track.name;
                    const artist = track.artist['#text'] || track.artist;
                    const isNowPlaying = track['@attr'] && track['@attr'].nowplaying === 'true';
                    
                    // Get album art
                    let albumArt = null;
                    if (track.image && track.image.length > 0) {
                        // Last.fm provides multiple sizes, get the largest
                        const largeImage = track.image.find(img => img.size === 'extralarge') || 
                                         track.image.find(img => img.size === 'large') ||
                                         track.image[track.image.length - 1];
                        if (largeImage && largeImage['#text']) {
                            albumArt = largeImage['#text'];
                        }
                    }
                    
                    document.getElementById('spotify1').innerHTML = `
                        <div class="spotify-song">${escapeHtml(song)}</div>
                        <div class="spotify-artist">${escapeHtml(artist)}</div>
                    `;
                    
                    // Update album art
                    if (albumArt) {
                        document.getElementById('ytMusicAlbum').innerHTML = `<img src="${albumArt}" alt="Album">`;
                    } else {
                        document.getElementById('ytMusicAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                    }
                    
                    // Save to Firebase so other user can see
                    if (firebaseInitialized) {
                        db.ref('music/youtube').set({
                            song: song,
                            artist: artist,
                            albumArt: albumArt,
                            nowPlaying: isNowPlaying,
                            timestamp: Date.now()
                        });
                    }
                } else {
                    document.getElementById('spotify1').innerHTML = '<div class="spotify-offline">Nothing playing</div>';
                    document.getElementById('ytMusicAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                }
            } catch (error) {
                console.error('Last.fm error:', error);
                document.getElementById('spotify1').innerHTML = '<div class="spotify-offline">Connection error</div>';
                document.getElementById('ytMusicAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
            }
        }

        // === FETCH SPOTIFY (Right Side) ===
        async function fetchSpotifyNowPlaying() {
            if (!spotifyToken) {
                // Check Firebase for updates from the other user
                if (firebaseInitialized) {
                    const snapshot = await db.ref('music/spotify').once('value');
                    const data = snapshot.val();
                    
                    if (data && data.song) {
                        document.getElementById('spotify2').innerHTML = `
                            <div class="spotify-song">${escapeHtml(data.song)}</div>
                            <div class="spotify-artist">${escapeHtml(data.artist || '')}</div>
                        `;
                        
                        // Show album art if available
                        if (data.albumArt) {
                            document.getElementById('spotifyAlbum').innerHTML = `<img src="${data.albumArt}" alt="Album">`;
                        }
                        return;
                    }
                }
                
                document.getElementById('spotify2').innerHTML = '<div class="spotify-offline">Not connected</div>';
                document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                return;
            }
            
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: {
                        'Authorization': `Bearer ${spotifyToken}`
                    }
                });
                
                if (response.status === 401) {
                    // Token expired
                    localStorage.removeItem('spotify_token');
                    spotifyToken = null;
                    document.getElementById('spotify2').innerHTML = '<div class="spotify-offline">Token expired - reconnect</div>';
                    document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                    return;
                }
                
                if (response.status === 204) {
                    document.getElementById('spotify2').innerHTML = '<div class="spotify-offline">Nothing playing</div>';
                    document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                    
                    // Clear from Firebase
                    if (firebaseInitialized) {
                        db.ref('music/spotify').remove();
                    }
                    return;
                }
                
                const data = await response.json();
                
                if (data && data.item) {
                    const song = data.item.name;
                    const artist = data.item.artists.map(a => a.name).join(', ');
                    
                    // Get album art
                    let albumArt = null;
                    if (data.item.album && data.item.album.images && data.item.album.images.length > 0) {
                        // Spotify provides multiple sizes, get medium or large
                        albumArt = data.item.album.images[0].url;
                    }
                    
                    document.getElementById('spotify2').innerHTML = `
                        <div class="spotify-song">${escapeHtml(song)}</div>
                        <div class="spotify-artist">${escapeHtml(artist)}</div>
                    `;
                    
                    // Update album art
                    if (albumArt) {
                        document.getElementById('spotifyAlbum').innerHTML = `<img src="${albumArt}" alt="Album">`;
                    } else {
                        document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                    }
                    
                    // Save to Firebase so other user can see
                    if (firebaseInitialized) {
                        db.ref('music/spotify').set({
                            song: song,
                            artist: artist,
                            albumArt: albumArt,
                            timestamp: Date.now()
                        });
                    }
                } else {
                    document.getElementById('spotify2').innerHTML = '<div class="spotify-offline">Nothing playing</div>';
                    document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                }
            } catch (error) {
                console.error('Spotify error:', error);
                document.getElementById('spotify2').innerHTML = '<div class="spotify-offline">Connection error</div>';
                document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
            }
        }

        // Listen to Firebase for music updates
        function setupMusicListeners() {
            if (!firebaseInitialized) return;
            
            // Listen to YouTube Music updates
            db.ref('music/youtube').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.song) {
                    document.getElementById('spotify1').innerHTML = `
                        <div class="spotify-song">${escapeHtml(data.song)}</div>
                        <div class="spotify-artist">${escapeHtml(data.artist || '')}</div>
                    `;
                    
                    // Update album art
                    if (data.albumArt) {
                        document.getElementById('ytMusicAlbum').innerHTML = `<img src="${data.albumArt}" alt="Album">`;
                    } else {
                        document.getElementById('ytMusicAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                    }
                }
            });
            
            // Listen to Spotify updates
            db.ref('music/spotify').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data && data.song) {
                    document.getElementById('spotify2').innerHTML = `
                        <div class="spotify-song">${escapeHtml(data.song)}</div>
                        <div class="spotify-artist">${escapeHtml(data.artist || '')}</div>
                    `;
                    
                    // Update album art
                    if (data.albumArt) {
                        document.getElementById('spotifyAlbum').innerHTML = `<img src="${data.albumArt}" alt="Album">`;
                    } else {
                        document.getElementById('spotifyAlbum').innerHTML = '<div class="album-placeholder">üéµ</div>';
                    }
                }
            });
        }

        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        document.getElementById('mealInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addMeal();
        });

        // Notification System
        let lastTaskCount = 0;
        let lastMealCount = 0;

        async function requestNotificationPermission() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    console.log('Notification permission granted');
                }
            }
        }

        function sendLocalNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    // Use service worker notification
                    navigator.serviceWorker.ready.then((registration) => {
                        registration.showNotification(title, {
                            body: body,
                            icon: 'icon-192.png',
                            badge: 'icon-192.png',
                            vibrate: [200, 100, 200],
                            tag: 'daily-tracker-update'
                        });
                    });
                } else {
                    // Fallback to regular notification
                    new Notification(title, {
                        body: body,
                        icon: 'icon-192.png'
                    });
                }
            }
        }

        function checkForNewTasks(tasksObj) {
            const taskCount = Object.keys(tasksObj).length;
            
            if (lastTaskCount > 0 && taskCount > lastTaskCount) {
                // New task added!
                const tasks = Object.entries(tasksObj).map(([id, task]) => ({ id, ...task }));
                const newestTask = tasks[tasks.length - 1];
                sendLocalNotification('üìù New Task Added!', newestTask.text);
            }
            
            lastTaskCount = taskCount;
        }

        function checkForNewMeals(mealsObj) {
            const mealCount = Object.keys(mealsObj).length;
            
            if (lastMealCount > 0 && mealCount > lastMealCount) {
                // New meal added!
                const meals = Object.entries(mealsObj).map(([id, meal]) => ({ id, ...meal }));
                const newestMeal = meals[meals.length - 1];
                sendLocalNotification('üçΩÔ∏è New Meal Added!', newestMeal.text);
            }
            
            lastMealCount = mealCount;
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            // Only register if we're on the actual site, not preview
            if (window.location.hostname !== 'www.claudeusercontent.com') {
                navigator.serviceWorker.register('sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered:', registration);
                    })
                    .catch((error) => {
                        console.log('Service Worker registration failed:', error);
                    });
            }
        }

        initWaterGlasses();
        updateGreeting();
        checkSetup();
        checkUserLogin();
        checkSpotifyToken();
        setupMusicListeners();
        setupMessagingListeners();
        
        // Request notification permission on load
        setTimeout(requestNotificationPermission, 2000);
        
        // Check if Spotify needs authorization
        const spotifyClientId = localStorage.getItem('spotify_client_id');
        if (spotifyClientId && !spotifyToken) {
            document.getElementById('spotifyReconnectBtn').style.display = 'block';
            document.getElementById('spotify2').innerHTML = '<div class="spotify-offline">Click button below to authorize</div>';
        }
        
        // Fetch initial music state
        fetchYouTubeMusicNowPlaying();
        fetchSpotifyNowPlaying();
        
        // Update music every 30 seconds
        setInterval(() => {
            fetchYouTubeMusicNowPlaying();
            fetchSpotifyNowPlaying();
        }, 30000);
        
        setInterval(updateGreeting, 60000);
    </script>
</body>
</html>
